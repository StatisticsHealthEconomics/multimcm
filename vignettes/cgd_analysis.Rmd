---
title: "CGD analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cgd_analysis}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: bibliography.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, warning=FALSE, message=FALSE}
library(purrr)
library(reshape2)
library(dplyr)
library(rstan)
library(dplyr)
library(glue)
library(abind)
library(survival)
library(multimcm)
library(frailtyHL)

# rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores() - 1)
```

# Introduction

The analysis is a comparison with a frequentist analysis in @Lai2009.


# Data

The data is chronic granulomatous disease (CGD) data available as part of the `frailtyHL` package.

```{r}
data(cgd)
head(cgd)
```

```{r}
cgd <- mutate(cgd, time = tstop - tstart)
# center_id = as.numeric(as.factor(center))
```

The data has repeat measurements and 13 hospitals so for simplicity we'll remove some of the data in the initial analyses.

```{r first-measurement}
cgd_first <-
  cgd |> 
  group_by(id) |> 
  arrange(tstart) |> 
  filter(row_number() == 1)
```

```{r filter-center}
cgd_center <- cgd_first |>
  # filter(center %in% c("Amsterdam", "NIH", "Univ. of Zurich", "Scripps Institute")) |>
  droplevels() |> 
  mutate(center_id = as.numeric(center))
```

Append background hazard rate by age, sex and country.

```{r bg-hazard}
cgd_center <- cgd_center |>
  tidyr::separate(hos.cat, c("country", "hospital")) |> 
  mutate(country = toupper(country),
         age_event = round(age + time/365.25, 0),   # convert from days to years
         country = ifelse(center == "Amsterdam", "NETHERLANDS",
                   ifelse(center == "Univ. of Zurich", "SWITZERLAND",
                   ifelse(center == "Copenhagen", "DENMARK", country)))) |> 
  select(-hospital)

load("../bgfscure/data/bg.mortality.RData")

# haramonise fields
bg.mortality <- bg.mortality |> 
  mutate(ACOUNTRY = toupper(ACOUNTRY),
         ACOUNTRY = ifelse(ACOUNTRY == "UNITED STATES", "US", ACOUNTRY),
         SEX = ifelse(SEX == "M", "male", "female"),
         rate = ifelse(rate == 0, 1e-10, rate)) |>  # replace so >0
  rename(country = ACOUNTRY,
         sex = SEX,
         age_event = Age)

input_data <- merge(cgd_center, bg.mortality,
                    by = c("age_event", "sex", "country"), sort = FALSE)
```


# Analysis

```{r}
out <-
  bmcm_stan(
    input_data = input_data,
    formula = "Surv(time=time, event=status) ~ 1",
    cureformula = "~ treat + (1 | center_id)",
    family_latent = "exponential",
    prior_cure = NA,
    centre_coefs = TRUE,
    bg_model = "bg_fixed",
    bg_varname = "rate",
    bg_hr = 1,
    t_max = 365)
```


plots

```{r}
library(ggplot2)

gg <- plot_S_joint(out,
                   add_km = TRUE,
                   annot_cf = FALSE)
gg + xlim(0,365) + facet_wrap(~endpoint)
```

```{r eval=FALSE}
ggsave(filename = "plots/cgd_surv_plot.png", dpi = 640, width = 10, height = 8)
```

## References
